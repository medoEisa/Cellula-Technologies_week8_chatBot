import React, { useState, useRef, useEffect } from "react";
import axios from "axios";
import { FiSend, FiLogOut } from "react-icons/fi";

function App() {
  const [view, setView] = useState(""); // "login", "signup", "chat"
  const [username, setUsername] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [token, setToken] = useState(null);
  const [message, setMessage] = useState("");
  const [userInput, setUserInput] = useState("");
  const [chatHistory, setChatHistory] = useState([]);
  const [typing, setTyping] = useState(false);
  const chatEndRef = useRef(null);

  const backendUrl = "http://localhost:8000";

  // ----------------- Auth -----------------
  const handleSignup = async () => {
    triggerParticles("signupBtn");
    try {
      const res = await axios.post(`${backendUrl}/signup`, { username, email, password });
      setMessage(`ðŸŽ‰ Signup successful! User ID: ${res.data.id}`);
      setView("login");
    } catch (err) {
      setMessage(err.response?.data?.detail || "Signup failed âŒ");
    }
  };

  const handleLogin = async () => {
    triggerParticles("loginBtn");
    try {
      const res = await axios.post(`${backendUrl}/login`, { email, password });
      setToken(res.data.access_token);
      setMessage(`âœ… Login successful! Welcome ${res.data.username}`);
      setView("chat");

      const historyRes = await axios.get(`${backendUrl}/history`, {
        headers: { Authorization: res.data.access_token }
      });
      setChatHistory(historyRes.data || []);
    } catch (err) {
      setMessage(err.response?.data?.detail || "Login failed âŒ");
    }
  };

  const handleLogout = () => {
    triggerParticles("logoutBtn");
    setToken(null);
    setView("");
    setChatHistory([]);
    setMessage("ðŸ‘‹ Logged out successfully.");
  };

  // ----------------- Chat -----------------
  const sendMessage = async () => {
    if (!userInput.trim()) return;
    triggerParticles("sendBtn");

    const newUserMsg = { sender: "user", content: userInput, timestamp: new Date() };
    setChatHistory(prev => [...prev, newUserMsg]);
    setUserInput("");
    setTyping(true);

    try {
      const res = await axios.post(
        `${backendUrl}/chat`,
        { user_input: userInput },
        { headers: { Authorization: token } }
      );

      setTimeout(() => {
        const agentMsg = {
          sender: "agent",
          content: res.data.response,
          tool: res.data.tool_used || "",
          timestamp: new Date()
        };
        setChatHistory(prev => [...prev, agentMsg]);
        setTyping(false);
      }, 1000 + Math.random() * 1000);
    } catch (err) {
      setMessage(err.response?.data?.detail || "Failed to send message âŒ");
      setTyping(false);
    }
  };

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatHistory, typing]);

  const handleKeyPress = (e) => {
    if (e.key === "Enter") sendMessage();
  };

  // ----------------- Particle Animation -----------------
  const triggerParticles = (id) => {
    const btn = document.getElementById(id);
    if (!btn) return;

    for (let i = 0; i < 10; i++) {
      const particle = document.createElement("div");
      particle.className = "particle";
      particle.style.left = `${Math.random() * 80 + 10}%`;
      particle.style.top = `${Math.random() * 80 + 10}%`;
      btn.appendChild(particle);
      setTimeout(() => particle.remove(), 600);
    }
  };

  // ----------------- Styles -----------------
  const bubbleStyle = (sender) => ({
    display: "inline-block",
    padding: "10px 15px",
    borderRadius: "20px",
    margin: "5px 0",
    maxWidth: "70%",
    textAlign: "left",
    animation: "fadeIn 0.5s",
    background: sender === "user" ? "linear-gradient(90deg, #6a11cb 0%, #2575fc 100%)" : "#f0f0f0",
    color: sender === "user" ? "white" : "black",
    alignSelf: sender === "user" ? "flex-end" : "flex-start",
    boxShadow: "0 2px 5px rgba(0,0,0,0.2)",
    wordBreak: "break-word"
  });

  const containerStyle = {
    display: "flex",
    flexDirection: "column",
    maxWidth: 800,
    margin: "20px auto",
    fontFamily: "Arial, sans-serif",
    borderRadius: 15,
    padding: 20,
    minHeight: "95vh",
    background: "rgba(0,0,0,0.1)",
    color: "#fff",
  };

  const chatBoxStyle = {
    flex: 1,
    border: "1px solid #ccc",
    borderRadius: 15,
    padding: 15,
    overflowY: "auto",
    display: "flex",
    flexDirection: "column",
    marginBottom: 10,
    background: "rgba(0,0,0,0.05)"
  };

  const buttonStyle = {
    padding: "10px 20px",
    marginLeft: "10px",
    borderRadius: "10px",
    border: "none",
    cursor: "pointer",
    fontSize: "1rem",
    fontWeight: "500",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    transition: "0.3s",
    background: "#2575fc",
    color: "#fff",
  };

  const inputStyle = {
    flex: 1,
    padding: 10,
    borderRadius: 10,
    border: "1px solid #ccc",
    outline: "none",
    fontSize: "1rem"
  };

  return (
    <div style={containerStyle}>
      <div className="animated-background" />

      {view === "chat" ? (
        <>
          <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 10 }}>
            <h1 style={{ color: "white" }}>Cellula Chat</h1>
            <button id="logoutBtn" style={buttonStyle} onClick={handleLogout}>
              <FiLogOut style={{ marginRight: 5 }} /> Logout
            </button>
          </div>

          <div style={chatBoxStyle}>
            {chatHistory.map((msg, idx) => (
              <div key={idx} style={bubbleStyle(msg.sender)}>
                {msg.sender === "user" ? "ðŸ§‘ " : "ðŸ¤– "} {msg.content}
                {msg.tool && msg.sender === "agent" && (
                  <div style={{ fontSize: "0.75em", color: "#bbb", marginTop: 2 }}>
                    ðŸ›  Tool used: {msg.tool}
                  </div>
                )}
                <div style={{ fontSize: "0.7em", color: "#999", marginTop: 2, textAlign: msg.sender === "user" ? "right" : "left" }}>
                  {new Date(msg.timestamp).toLocaleTimeString()}
                </div>
              </div>
            ))}
            {typing && (
              <div style={bubbleStyle("agent")}>
                ðŸ¤– Agent is typing<span className="typing-dots"><span>.</span><span>.</span><span>.</span></span>
              </div>
            )}
            <div ref={chatEndRef} />
          </div>

          <div style={{ display: "flex", marginTop: 10 }}>
            <input
              type="text"
              value={userInput}
              onChange={(e) => setUserInput(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="Type a message..."
              style={inputStyle}
            />
            <button id="sendBtn" style={buttonStyle} onClick={sendMessage}>
              <FiSend />
            </button>
          </div>
          {message && <p style={{ color: "yellow" }}>{message}</p>}
        </>
      ) : (
        <>
          <h1 style={{ color: "white", textAlign: "center" }}>Cellula Chat App</h1>
          {!view && (
            <div style={{ textAlign: "center", marginTop: 20 }}>
              <button style={{ ...buttonStyle, padding: "10px 22px" }} onClick={() => setView("login")}>Login</button>
              <button style={{ ...buttonStyle, marginLeft: 10, background: "#6a11cb", padding: "10px 22px" }} onClick={() => setView("signup")}>Signup</button>
            </div>
          )}
          {view && (
            <div style={{ marginTop: 20 }}>
              {view === "signup" && (
                <input
                  type="text"
                  placeholder="Username"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  style={{ display: "block", margin: "10px auto", padding: 10, width: "80%" }}
                />
              )}
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                style={{ display: "block", margin: "10px auto", padding: 10, width: "80%" }}
              />
              <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={{ display: "block", margin: "10px auto", padding: 10, width: "80%" }}
              />
              {view === "signup" ? (
                <button style={{ ...buttonStyle, padding: "10px 22px", marginTop: 10 }} onClick={handleSignup}>Signup</button>
              ) : (
                <button style={{ ...buttonStyle, padding: "10px 22px", marginTop: 10 }} onClick={handleLogin}>Login</button>
              )}
            </div>
          )}
          {message && <p style={{ color: "yellow", textAlign: "center" }}>{message}</p>}
        </>
      )}

      <style>
        {`
          .animated-background {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            overflow: hidden;
          }
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px);}
            to { opacity: 1; transform: translateY(0);}
          }
          .particle {
            position: absolute;
            width: 8px; height: 8px;
            background: white;
            border-radius: 50%;
            animation: particleMove 0.6s ease-out forwards;
          }
          @keyframes particleMove {
            0% { transform: translate(0,0) scale(1); opacity: 1;}
            100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0;}
          }
          .typing-dots span {
            animation: blink 1.4s infinite;
            display: inline-block;
            margin-left: 2px;
          }
          .typing-dots span:nth-child(1) { animation-delay: 0s; }
          .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
          .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
          @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
          }
          button:hover { opacity: 0.85; }
        `}
      </style>
    </div>
  );
}

export default App;
